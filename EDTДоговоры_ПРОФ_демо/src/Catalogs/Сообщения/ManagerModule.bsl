#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Создает новое сообщение.
//
// Параметры:
//  Автор - СправочникСсылка.Пользователи - Автор сообщения.
//  Кому - СправочникСсылка.Пользователи - Адресат сообщения.
//  Текст - Строка - Текст сообщения.
//  Предмет - СправочникСсылка.ДоговорныеДокументы - Предмет сообщения.
//
Процедура Добавить(Автор, Кому, Текст, Предмет) Экспорт
	
	КлючеваяОперация = "СообщенияДобавлениеПрограммное";
	ВремяНачала = ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(КлючеваяОперация);
	
	Сообщение = Справочники.Сообщения.СоздатьЭлемент();
	Сообщение.Автор = Автор;
	Сообщение.Кому = Кому;
	Сообщение.Текст = Текст;
	Сообщение.Предмет = Предмет;
	Сообщение.Дата = ТекущаяДата();
	
	Сообщение.Записать();
	
	РаботаССообщениями.ЗапуститьРассылкуСообщений();
	
	ОценкаПроизводительностиКлиентСервер.ЗакончитьЗамерВремени(КлючеваяОперация, ВремяНачала);
	
КонецПроцедуры

// Устанавливает пометку удаления всем сообщениям с указанным предметом.
//
// Параметры:
//  Предмет - СправочникСсылка.ДоговорныеДокументы - Предмет сообщений.
//
Процедура ПометитьНаУдалениеПоПредмету(Предмет) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	НачатьТранзакцию();
	Попытка
		
		ЗаписьУжеЕстьВБазе = Ложь;
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("Справочник.Сообщения");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.УстановитьЗначение("Предмет", Предмет);
		Блокировка.Заблокировать();
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	Сообщения.Ссылка
			|ИЗ
			|	Справочник.Сообщения КАК Сообщения
			|ГДЕ
			|	Сообщения.Предмет = &Предмет
			|	И Сообщения.ПометкаУдаления = ЛОЖЬ";
		
		Запрос.УстановитьПараметр("Предмет", Предмет);
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			СообщениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
			СообщениеОбъект.УстановитьПометкуУдаления(Истина);
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли